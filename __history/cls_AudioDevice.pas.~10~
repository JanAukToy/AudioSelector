unit cls_AudioDevice;

interface

uses
  System.SysUtils,
  System.Classes,
  System.Win.ComObj,
  System.SyncObjs,
  Winapi.Windows,
  Winapi.ActiveX,
  Winapi.PropSys,
  JAT.MMDeviceAPI, JAT.EndpointVolume;

type
  TAudioDeviceProps = record
    InterfaceFriendlyName: string;
    DeviceDesc: string;
    FriendlyName: string;
    InstanceId: string;
    ContainerId: TGUID;
  end;

  TAudioDevice = class
  private
    f_Device: IMMDevice;
    f_AudioEndpointVolume: IAudioEndpointVolume;
    f_Props: TAudioDeviceProps;

    procedure GetProps(const a_PropertyStore: IPropertyStore);
  public
    constructor Create(const a_Device: IMMDevice);
    destructor Destroy; override;
  end;

implementation

{ TAudioDevice }

// *****************************************************************************
// Constructor
constructor TAudioDevice.Create(const a_Device: IMMDevice);
var
  l_Id: PWideChar;
  l_PropertyStore: IPropertyStore;
  l_PointAudioEndpointVolume: Pointer;
  l_PointAudioClient: Pointer;
begin
  // Store Device
  f_Device := a_Device;

  // Get Device ID
  if Succeeded(a_Device.GetId(l_Id)) then
  begin
    // Store ID
    f_Props.InstanceId := l_Id;

    // Get Open Property Interface
    if Succeeded(a_Device.OpenPropertyStore(STGM_READ, l_PropertyStore)) then
    begin
      // Get Properties
      GetProps(l_PropertyStore);
    end;

    // Get Audio Endpoint Volume
    if Succeeded(a_Device.Activate(IID_IAudioEndpointVolume,
      CLSCTX_INPROC_SERVER, nil, l_PointAudioEndpointVolume)) then
    begin
      f_AudioEndpointVolume := IAudioEndpointVolume(l_PointAudioEndpointVolume)
        as IAudioEndpointVolume;
    end;
  end;
end;

// *****************************************************************************
// Destructor
destructor TAudioDevice.Destroy;
begin
  inherited;
end;

// *****************************************************************************
// Get Properties
procedure TAudioDevice.GetProps(const a_PropertyStore: IPropertyStore);
var
  l_PropValue: TPropVariant;
begin
  if Succeeded(a_PropertyStore.GetValue(PKEY_DeviceInterface_FriendlyName,
    l_PropValue)) then
  begin
    f_Props.InterfaceFriendlyName := l_PropValue.pwszVal;
  end;

  ZeroMemory(@l_PropValue, SizeOf(l_PropValue));

  if Succeeded(a_PropertyStore.GetValue(PKEY_Device_DeviceDesc, l_PropValue))
  then
  begin
    f_Props.DeviceDesc := l_PropValue.pwszVal;
  end;

  ZeroMemory(@l_PropValue, SizeOf(l_PropValue));

  if Succeeded(a_PropertyStore.GetValue(PKEY_Device_FriendlyName, l_PropValue))
  then
  begin
    f_Props.FriendlyName := l_PropValue.pwszVal;
  end;

  ZeroMemory(@l_PropValue, SizeOf(l_PropValue));

  // [ PKEY_Device_InstanceId ] is IMMDevice::GetId Value

  if Succeeded(a_PropertyStore.GetValue(PKEY_Device_ContainerId, l_PropValue))
  then
  begin
    f_Props.ContainerId := l_PropValue.puuid^;
  end;
end;

end.
